# Laravel Coolify

Dashboard, CLI tools, and intelligent Nixpacks generation for deploying Laravel apps on Coolify.

## Features

- **Web Dashboard** at `/coolify` - deployments, logs, databases, environment variables
- **Artisan Commands** - deploy, status, logs, restart, rollback
- **Nixpacks Generation** - auto-detects Horizon, Reverb, Scheduler and generates optimized `nixpacks.toml`
- **Provisioning** - create app + Postgres + Redis on Coolify from scratch

## Requirements

- PHP 8.2+
- Laravel 11 or 12
- Coolify instance with API token

## Installation

```bash
composer require stumason/laravel-coolify
php artisan coolify:install
```

This will:

1. Publish the config file
2. Detect installed packages (Horizon, Reverb, Scheduler)
3. Generate an optimized `nixpacks.toml`

Add to `.env`:

```env
COOLIFY_URL=https://app.coolify.io
COOLIFY_TOKEN=your-api-token
```

The token needs to be a **root-level API token** (created by a Coolify admin under Keys & Tokens > API Tokens).

## Nixpacks Generation

The `coolify:install` command automatically detects your Laravel packages and generates an optimized `nixpacks.toml`:

```toml
# Generated by laravel-coolify

[phases.setup]
nixPkgs = ["nodejs_20"]

[phases.build]
cmds = [
    "composer install --no-dev --optimize-autoloader",
    "npm ci",
    "npm run build",
    "php artisan config:cache",
    "php artisan route:cache",
    "php artisan view:cache",
]

[start]
cmd = "php-fpm"

[processes]
web = "php-fpm"
horizon = "php artisan horizon"
reverb = "php artisan reverb:start --host=0.0.0.0 --port=8080"
scheduler = "php artisan schedule:work"
```

### Detected Packages

| Package         | Process Added                                          |
| --------------- | ------------------------------------------------------ |
| Laravel Horizon | `php artisan horizon`                                  |
| Laravel Reverb  | `php artisan reverb:start --host=0.0.0.0 --port=8080`  |
| Task Scheduler  | `php artisan schedule:work`                            |

### Configuration

Customize in `config/coolify.php`:

```php
'nixpacks' => [
    'node_version' => env('COOLIFY_NODE_VERSION', 'nodejs_20'),
    'web_command' => env('COOLIFY_WEB_COMMAND', 'php-fpm'),
],
```

For Laravel Octane, set:

```env
COOLIFY_WEB_COMMAND="php artisan octane:start --host=0.0.0.0 --port=8080"
```

## Commands

```bash
php artisan coolify:install          # Install config + generate nixpacks.toml
php artisan coolify:install --force  # Overwrite existing files

php artisan coolify:status           # Show app status
php artisan coolify:status --all     # Show all resources

php artisan coolify:deploy           # Trigger deployment
php artisan coolify:deploy --tag=v1  # Deploy specific tag

php artisan coolify:logs             # View application logs
php artisan coolify:restart          # Restart application
php artisan coolify:rollback         # Rollback to previous deployment
```

## Dashboard

Available at `/coolify`. Shows:

- Deployment history and build logs
- Application logs
- Database/Redis status with start/stop controls
- Environment variables (view, add, delete)

Only accessible in `local` environment by default. For production access:

```php
// In AppServiceProvider or CoolifyServiceProvider
use Stumason\Coolify\Facades\Coolify;

Coolify::auth(function ($request) {
    return $request->user()?->isAdmin();
});
```

## Facade

```php
use Stumason\Coolify\Facades\Coolify;

// Quick actions
Coolify::deploy();
Coolify::deploy('custom-uuid');
Coolify::status();
Coolify::logs();

// Repositories
Coolify::applications()->all();
Coolify::applications()->find($uuid);
Coolify::databases()->all();
Coolify::deployments()->all();
Coolify::servers()->all();
Coolify::projects()->all();
```

## Testing

```bash
composer test          # Run tests
composer test:coverage # Run with coverage
composer lint          # PHPStan + Pint
```

## License

MIT
