# Laravel Coolify

Dashboard, CLI tools, and intelligent Nixpacks generation for deploying Laravel apps on Coolify.

## Features

- **Web Dashboard** at `/coolify` - deployments, logs, databases, environment variables
- **Artisan Commands** - deploy, status, logs, restart, rollback with real-time log streaming
- **Nixpacks Generation** - auto-detects Horizon, Reverb, Scheduler and generates production-ready `nixpacks.toml` with Supervisor
- **One-Command Provisioning** - create app + Postgres + Redis on Coolify and deploy in a single command

## Requirements

- PHP 8.2+
- Laravel 11 or 12
- Coolify instance with API token

## Installation

```bash
composer require stumason/laravel-coolify
php artisan coolify:install
```

This will:

1. Publish the config file
2. Detect installed packages (Horizon, Reverb, Scheduler)
3. Generate an optimized `nixpacks.toml`

Add to `.env`:

```env
COOLIFY_URL=https://app.coolify.io
COOLIFY_TOKEN=your-api-token
```

The token needs to be a **root-level API token** (created by a Coolify admin under Keys & Tokens > API Tokens).

## Nixpacks Generation

The `coolify:install` command automatically detects your Laravel packages and generates a production-ready `nixpacks.toml` with Supervisor for process management:

```toml
# Generated by laravel-coolify

[phases.setup]
nixPkgs = ["nodejs_22", "(php84.withExtensions ...)", "php84Packages.composer", "nginx", "python311Packages.supervisor"]

[phases.install]
onlyIncludeFiles = ["composer.json", "composer.lock", "package.json", "package-lock.json"]
cacheDirectories = ["vendor", "/root/.composer/cache", "node_modules"]
cmds = [
    "composer install --no-dev --optimize-autoloader --no-scripts",
    "npm ci",
]

[phases.build]
dependsOn = ["install"]
cmds = [
    "mkdir -p /var/log /app/storage/framework/{views,cache,sessions} ...",
    "cp /assets/worker-*.conf /etc/supervisor/conf.d/",
    # ... setup supervisor configs
]

[phases.postbuild]
dependsOn = ["build"]
cmds = ["npm run build", "php artisan optimize"]

[start]
cmd = "/assets/start.sh"

[staticAssets]
# Embedded configs for: start.sh, supervisord.conf, nginx.template.conf,
# php-fpm.conf, worker-nginx.conf, worker-phpfpm.conf, worker-horizon.conf,
# worker-reverb.conf
```

The generated config includes:

- **Nginx** with PHP-FPM for serving your app
- **Supervisor** managing all processes
- **Horizon** worker (if detected)
- **Reverb** WebSocket server (if detected)
- **Database migrations** run automatically on deploy

### Detected Packages

| Package         | Supervisor Worker Added                                |
| --------------- | ------------------------------------------------------ |
| Laravel Horizon | `worker-horizon.conf` - runs `php artisan horizon`     |
| Laravel Reverb  | `worker-reverb.conf` - runs `php artisan reverb:start` |

### Configuration

Customize in `config/coolify.php`:

```php
'nixpacks' => [
    'node_version' => env('COOLIFY_NODE_VERSION', 'nodejs_22'),
    'php_version' => env('COOLIFY_PHP_VERSION', 'php84'),
],
```

## Commands

### Install & Setup

```bash
php artisan coolify:install          # Install config + generate nixpacks.toml
php artisan coolify:install --force  # Overwrite existing files
```

### Provisioning

Create your entire infrastructure on Coolify in one command:

```bash
php artisan coolify:provision                    # Interactive setup
php artisan coolify:provision --deploy           # Provision AND deploy immediately
php artisan coolify:provision --no-postgres      # Skip PostgreSQL
php artisan coolify:provision --no-redis         # Skip Redis
```

Pre-flight checks ensure you have:

- A Git repository with a GitHub remote configured
- A `nixpacks.toml` file (offers to generate one if missing)

After provisioning, you'll see your webhook URL for GitHub integration.

### Deployment

```bash
php artisan coolify:deploy              # Trigger deployment
php artisan coolify:deploy --wait       # Wait and stream build logs in real-time
php artisan coolify:deploy --debug      # Show hidden debug logs (default with --wait)
php artisan coolify:deploy --tag=v1.0   # Deploy specific git tag
php artisan coolify:deploy --force      # Skip confirmation prompt
```

### Monitoring

```bash
php artisan coolify:status           # Show app status
php artisan coolify:status --all     # Show all resources

php artisan coolify:logs             # View application logs
php artisan coolify:logs --deployment=uuid --debug  # View deployment build logs
```

### Management

```bash
php artisan coolify:restart          # Restart application
php artisan coolify:rollback         # Rollback to previous deployment
```

## Dashboard

Available at `/coolify`. Shows:

- Deployment history and build logs
- Application logs
- Database/Redis status with start/stop controls
- Environment variables (view, add, delete)

Only accessible in `local` environment by default. For production access:

```php
// In AppServiceProvider or CoolifyServiceProvider
use Stumason\Coolify\Facades\Coolify;

Coolify::auth(function ($request) {
    return $request->user()?->isAdmin();
});
```

## Facade

```php
use Stumason\Coolify\Facades\Coolify;

// Quick actions
Coolify::deploy();
Coolify::deploy('custom-uuid');
Coolify::status();
Coolify::logs();

// Repositories
Coolify::applications()->all();
Coolify::applications()->find($uuid);
Coolify::databases()->all();
Coolify::deployments()->all();
Coolify::servers()->all();
Coolify::projects()->all();
```

## Testing

```bash
composer test          # Run tests
composer test:coverage # Run with coverage
composer lint          # PHPStan + Pint
```

## License

MIT
